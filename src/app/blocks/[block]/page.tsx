import type { Metadata } from "next";
import { notFound } from "next/navigation";
import { BlockCodeExplorer } from "@/components/blocks/block-code-explorer";
import BlockDetails from "@/components/blocks/block-details";
import BlockPreview from "@/components/blocks/block-preview";
import BlockToolbar from "@/components/blocks/block-toolbar";
import { Navbar } from "@/components/layout/navbar";
import { DescriptionText, MainHeading } from "@/components/typography";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { blocks } from "@/config/registry";
import { constructMetadata } from "@/lib/metadata";
import { absoluteUrl, capitalize } from "@/lib/utils";
import { BlockProvider } from "@/providers/block-provider";
import registry from "../../../../registry.json";

export const generateStaticParams = async () => {
  return blocks.map(({ name }) => ({
    block: name,
  }));
};

export const generateMetadata = async (props: {
  params: Promise<{ block: string }>;
}): Promise<Metadata> => {
  const { block } = await props.params;
  const blockDetails = blocks.find((b) => b.name === block);

  if (!blockDetails) {
    throw new Error(`Block ${block} not found`);
  }

  return constructMetadata({
    title: `${blockDetails.title} - ${capitalize(
      blockDetails.categories[0].title
    )} section Shadcn UI block`,
    description: `Fully customized and responsive ${blockDetails.title} Shadcn UI block. Preview, customize, and copy ready-to-use code snippets.`,
    alternates: {
      canonical: absoluteUrl(`/blocks/${block}`),
    },
  });
};

const BlockPage = async (props: { params: Promise<{ block: string }> }) => {
  const params = await props.params;
  const { block } = params;

  const blockDetails = registry.items.find((item) => item.name === block);
  if (!blockDetails) notFound();

  const { title, description } = blockDetails;

  return (
    <BlockProvider name={block}>
      <Navbar />
      <div className="mx-auto mt-14 max-w-(--breakpoint-2xl) px-4 py-8">
        <MainHeading>{title}</MainHeading>
        {description && (
          <DescriptionText className="mt-1">{description}</DescriptionText>
        )}

        <Tabs className="mt-6" defaultValue="preview">
          <div className="mb-1 flex items-center justify-between gap-2 pr-1.5">
            <TabsList>
              <TabsTrigger value="preview">Preview</TabsTrigger>
              <TabsTrigger value="code">Code</TabsTrigger>
            </TabsList>
            <BlockToolbar />
          </div>

          <TabsContent value="preview">
            <BlockPreview />
          </TabsContent>
          <TabsContent value="code">
            <BlockCodeExplorer />
          </TabsContent>
        </Tabs>

        <BlockDetails />
      </div>
    </BlockProvider>
  );
};

export default BlockPage;
